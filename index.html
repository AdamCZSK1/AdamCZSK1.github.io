<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Praha hl. n. – Odjezdová tabule (SŽ styl)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: #001d3d;
      color: #fff;
      font-family: Arial, sans-serif;
    }
    .sz-header {
      background: #003566;
      font-weight: bold;
      text-transform: uppercase;
    }
    .sz-row {
      background: #00254d;
      border-bottom: 1px solid #003566;
    }
    .sz-row:nth-child(even) {
      background: #002a56;
    }
    .time-cell { color: #4cc3ff; font-weight: bold; }
    .countdown { color: #ffdd33; font-weight: bold; }
  </style>
</head>
<body class="p-6">
  <h1 class="text-4xl font-bold text-center mb-6">Praha hlavní nádraží – Odjezdy vlaků</h1>

  <div id="board" class="w-full max-w-5xl mx-auto text-lg"></div>

  <!-- Externí config s API klíčem -->
  <script src="config.js"></script>

  <script>
    async function loadDepartures() {
      const now = new Date();

      const url = `https://api.golemio.cz/v2/pid/gtfs/vehiclepositions`; // přesnější info o vlacích

      const response = await fetch(url, {
        headers: {
          "X-Access-Token": GOLEMIO_API_KEY,
        },
      });

      const data = await response.json();
      const vehicles = data.vehicle_positions || [];

      let departures = [];

      vehicles.forEach(v => {
        if (!v.trip || !v.stop_sequence || !v.stop) return;

        // typ 2 = vlaky (GTFS)
        if (v.route && v.route.type !== 2) return;

        const stopName = v.stop.stop_name.toLowerCase();
        if (!stopName.includes("hl.n") && !stopName.includes("hl. n") && !stopName.includes("hlavni")) return;

        if (!v.stop.departure_time) return;

        const dep = new Date(v.stop.departure_time);
        if (dep < now) return;

        departures.push({
          time: dep,
          line: v.route?.short_name || "-",
          headsign: v.trip?.trip_headsign || "-",
          platform: v.stop.platform_code || v.stop.platform_name || "-",
        });
      });

      departures.sort((a, b) => a.time - b.time);

      renderBoard(departures.slice(0, 12));
    }

    function renderBoard(list) {
      const out = [];

      out.push(`
        <table class='w-full border-collapse'>
          <tr class='sz-header'>
            <td class='p-3'>Čas</td>
            <td class='p-3'>Vlak</td>
            <td class='p-3'>Směr</td>
            <td class='p-3'>Nástupiště</td>
            <td class='p-3 text-right'>Odjezd za</td>
          </tr>
      `);

      const now = new Date();

      list.forEach(it => {
        const delay = it.delay || 0;
        const diff = Math.floor((it.time - now) / 1000);
        const m = Math.floor(diff / 60);
        const s = diff % 60;

        out.push(`
          <tr class='sz-row'>
            <td class='p-3 time-cell'>${it.time.toLocaleTimeString("cs-CZ", {hour: "2-digit", minute: "2-digit"})}</td>
            <td class='p-3'>${it.line}</td>
            <td class='p-3'>${it.headsign}</td>
            <td class='p-3'>${it.platform}</td>
            <td class='p-3 text-right countdown ${diff < 60 ? "animate-pulse" : ""}'>${m} min ${s}s ${delay>0?`(+${Math.floor(delay/60)} min)`:''}</td>
          </tr>
        `);
      });

      out.push(`</table>`);

      document.getElementById("board").innerHTML = out.join("");
    }

    loadDepartures();
    setInterval(loadDepartures, 15000);
    setInterval(loadDepartures, 1000);
  </script>
</body>
</html>
