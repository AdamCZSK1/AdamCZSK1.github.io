<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>PMDP – Odjezdová tabule</title>

<style>
body {
  margin: 0;
  background: #2f2a2c;
  font-family: Arial, Helvetica, sans-serif;
  color: #ffb400;
}
.board {
  width: 1000px;
  margin: 20px auto;
  border: 8px solid #5b5456;
  background: #000;
}
.top {
  background: #6a6265;
  color: #fff;
  padding: 10px 20px;
  display: flex;
  justify-content: space-between;
}
.stop {
  font-size: 28px;
  color: #9ad14b;
  font-weight: bold;
}
.time {
  font-size: 32px;
  background: #000;
  padding: 5px 15px;
}
.menu {
  background: #1a1a1a;
  padding: 10px;
}
select {
  font-size: 16px;
  padding: 5px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 28px;
}
th {
  text-align: left;
  padding: 10px;
  font-size: 14px;
  background: #000;
  color: #fff;
}
td {
  padding: 6px 10px;
}
.line { width: 80px; }
.minutes { text-align: right; width: 120px; }
</style>
</head>

<body>
<div class="board">
  <div class="top">
    <div class="stop" id="stopName">Vyber zastávku</div>
    <div class="time" id="clock">--:--</div>
  </div>

  <div class="menu">
    <select id="stopSelect"></select>
  </div>

  <table>
    <thead>
      <tr>
        <th class="line">LINKA</th>
        <th>CÍL</th>
        <th class="minutes">ODJEZD</th>
      </tr>
    </thead>
    <tbody id="departures"></tbody>
  </table>
</div>

<script>
let data = { services:{}, stops:{} };

const stopSelect = document.getElementById('stopSelect');
const stopName = document.getElementById('stopName');
const departuresEl = document.getElementById('departures');

function serviceValid(service) {
  const d = new Date();
  const ymd =
    d.getFullYear()*10000 +
    (d.getMonth()+1)*100 +
    d.getDate();

  const wd = (d.getDay() + 6) % 7;

  if (service.exceptions && service.exceptions[ymd] !== undefined) {
    return service.exceptions[ymd];
  }

  if (ymd < service.start || ymd > service.end) return false;
  return service.days[wd] === 1;
}

function nowMinutes() {
  const d = new Date();
  return d.getHours()*60 + d.getMinutes() + d.getSeconds()/60;
}

function timeToMinutes(t) {
  const [h,m,s] = t.split(':').map(Number);
  return h*60 + m + (s||0)/60;
}

function render(stop) {
  stopName.textContent = stop;
  departuresEl.innerHTML = '';
  const now = nowMinutes();

  data.stops[stop].departures
    .filter(d => serviceValid(data.services[d.service]))
    .map(d => {
      let diff = timeToMinutes(d.time) - now;
      if (diff < 0) diff += 1440;
      return {...d, diff};
    })
    .sort((a,b) => a.diff - b.diff)
    .slice(0,10)
    .forEach(d => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="line">${d.line}</td>
        <td>${d.dest}</td>
        <td class="minutes">${Math.floor(d.diff)} min</td>`;
      departuresEl.appendChild(tr);
    });
}

function updateClock() {
  const d = new Date();
  document.getElementById('clock').textContent =
    String(d.getHours()).padStart(2,'0') + ':' +
    String(d.getMinutes()).padStart(2,'0');
}

fetch('pmdp.json')
  .then(r => r.json())
  .then(j => {
    data = j;
    Object.keys(data.stops).forEach(s => {
      const o = document.createElement('option');
      o.value = s;
      o.textContent = s;
      stopSelect.appendChild(o);
    });
    render(stopSelect.value);
    setInterval(() => render(stopSelect.value), 30000);
  });

stopSelect.addEventListener('change', e => render(e.target.value));

updateClock();
setInterval(updateClock, 1000);
</script>
</body>
</html>
